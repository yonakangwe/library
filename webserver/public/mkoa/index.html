<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mikoa (Regions)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config({
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          boxShadow: {
            'card': '0 1px 3px 0 rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06)',
            'card-hover': '0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.06)',
          }
        }
      }
    });
  </script>
  <link rel="stylesheet" href="/css/app.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50/30 font-sans antialiased">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8 md:py-12 page-fade-in">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Mikoa</h1>
      <p class="mt-1 text-slate-500">Manage regions</p>
    </header>

    <!-- Add region card -->
    <section class="mb-8 rounded-2xl bg-white/80 card-appear hover:-translate-y-0.5 hover:shadow-card-hover transition-transform transition-shadow backdrop-blur-sm border border-slate-200/80 shadow-card overflow-hidden">
      <div class="px-6 py-5 border-b border-slate-100">
        <h2 class="text-lg font-semibold text-slate-800">Add region</h2>
        <p class="text-sm text-slate-500 mt-0.5">Create a new region with a unique code.</p>
      </div>
      <form id="createForm" class="p-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
          <div>
            <label for="newName" class="block text-sm font-medium text-slate-700 mb-1.5">Name</label>
            <input type="text" id="newName" required placeholder="e.g. Dar es Salaam"
              class="w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50/50 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent focus:bg-white transition">
          </div>
          <div>
            <label for="newCode" class="block text-sm font-medium text-slate-700 mb-1.5">Code</label>
            <input type="text" id="newCode" required placeholder="e.g. DSM" maxlength="20"
              class="w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50/50 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent focus:bg-white transition uppercase">
          </div>
          <div class="sm:col-span-2 lg:col-span-1 flex gap-2">
            <button type="submit" class="flex-1 px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition">
              Create
            </button>
          </div>
        </div>
      </form>
    </section>

    <!-- List section -->
    <section class="rounded-2xl bg-white/80 card-appear hover:-translate-y-0.5 hover:shadow-card-hover transition-transform transition-shadow backdrop-blur-sm border border-slate-200/80 shadow-card overflow-hidden">
      <div class="px-6 py-4 flex flex-wrap items-center justify-between gap-3 border-b border-slate-100">
        <div class="flex items-center gap-3">
          <h2 class="text-lg font-semibold text-slate-800">Regions</h2>
          <button type="button" id="refreshBtn" class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-300 transition">
            Refresh
          </button>
        </div>
        <p class="text-sm text-slate-500" id="meta"></p>
      </div>
      <div class="px-6 py-3 border-b border-slate-100 min-h-[2rem]">
        <p class="text-red-600 text-sm" id="error"></p>
        <p id="loading" class="text-slate-500 text-sm flex items-center gap-2" style="display:none;">
          <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          Loading…
        </p>
      </div>
      <div class="overflow-x-auto">
        <table id="table" class="w-full">
          <thead>
            <tr class="bg-slate-50/80 border-b border-slate-200">
              <th class="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">ID</th>
              <th class="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
              <th class="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">Code</th>
              <th class="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
              <th class="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">Created</th>
              <th class="text-right py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-100">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = '/library/api/v1';

    function clearError() {
      document.getElementById('error').textContent = '';
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
    }

    function statusBadge(status) {
      var c = (status || '').toLowerCase() === 'active'
        ? 'bg-emerald-100 text-emerald-700'
        : 'bg-slate-100 text-slate-600';
      return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + c + '">' + (status || '') + '</span>';
    }

    async function loadList() {
      const tbody = document.getElementById('tbody');
      const metaEl = document.getElementById('meta');
      const loadingEl = document.getElementById('loading');
      tbody.innerHTML = '';
      clearError();
      loadingEl.style.display = 'flex';

      try {
        const res = await fetch(API_BASE + '/mkoa/list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ page: 1, page_size: 20 })
        });
        const json = await res.json();

        if (json.code !== 200) {
          showError(json.error || 'Failed to load list');
          return;
        }

        const data = json.data || [];
        const meta = json.meta;
        if (meta) {
          metaEl.textContent = 'Page ' + meta.page + ' of ' + (meta.pages || 1) + ' · ' + (meta.total || 0) + ' total';
        }

        data.forEach(function (row) {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-50/50 transition row-appear';
          const created = row.created_at ? new Date(row.created_at).toLocaleString() : '';
          const actionsHtml =
            "<div class=\"inline-flex gap-2\">" +
            "<button type=\"button\" class=\"px-2.5 py-1 text-xs font-medium rounded-lg border border-slate-200 text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-300\" data-action=\"view\" data-id=\"" + row.id +
            "\" data-name=\"" + (row.name || "").replace(/\"/g, "&quot;") +
            "\" data-code=\"" + (row.code || "").replace(/\"/g, "&quot;") +
            "\" data-status=\"" + (row.status || "").replace(/\"/g, "&quot;") +
            "\" data-created=\"" + (created || "").replace(/\"/g, "&quot;") + "\">View</button>" +
            "<button type=\"button\" class=\"px-2.5 py-1 text-xs font-medium rounded-lg border border-indigo-100 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-300\" data-action=\"edit\" data-id=\"" + row.id +
            "\" data-name=\"" + (row.name || "").replace(/\"/g, "&quot;") +
            "\" data-code=\"" + (row.code || "").replace(/\"/g, "&quot;") +
            "\" data-status=\"" + (row.status || "").replace(/\"/g, "&quot;") + "\">Edit</button>" +
            "<button type=\"button\" class=\"btn-delete\" data-action=\"delete\" data-id=\"" + row.id +
            "\" data-name=\"" + (row.name || "").replace(/\"/g, "&quot;") + "\">Delete</button>" +
            "</div>";

          tr.innerHTML =
            '<td class="py-4 px-6 text-sm font-medium text-slate-900">' + row.id + '</td>' +
            '<td class="py-4 px-6 text-sm text-slate-700">' + (row.name || '') + '</td>' +
            '<td class="py-4 px-6 text-sm font-mono font-medium text-slate-700">' + (row.code || '') + '</td>' +
            '<td class="py-4 px-6">' + statusBadge(row.status) + '</td>' +
            '<td class="py-4 px-6 text-sm text-slate-500">' + created + '</td>' +
            '<td class="py-4 px-6 text-right">' + actionsHtml + '</td>';
          tbody.appendChild(tr);
        });
        // Wire up action buttons
        tbody.querySelectorAll('[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            deleteMkoa(parseInt(this.dataset.id, 10), this.dataset.name);
          });
        });
        tbody.querySelectorAll('[data-action="view"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            const row = {
              id: parseInt(this.dataset.id, 10),
              name: this.dataset.name || '',
              code: this.dataset.code || '',
              status: this.dataset.status || '',
              created: this.dataset.created || '',
            };
            viewMkoa(row);
          });
        });
        tbody.querySelectorAll('[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            const row = {
              id: parseInt(this.dataset.id, 10),
              name: this.dataset.name || '',
              code: this.dataset.code || '',
              status: this.dataset.status || '',
            };
            editMkoa(row);
          });
        });
      } catch (e) {
        showError('Request failed: ' + e.message);
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    async function viewMkoa(row) {
      await Swal.fire({
        title: row.name || '(no name)',
        html:
          '<div class="text-sm text-left space-y-1">' +
          '<div><span class="font-semibold text-slate-700">ID:</span> <span class="text-slate-600">' + row.id + '</span></div>' +
          '<div><span class="font-semibold text-slate-700">Code:</span> <span class="text-slate-600 font-mono">' + row.code + '</span></div>' +
          '<div><span class="font-semibold text-slate-700">Status:</span> ' + statusBadge(row.status) + '</div>' +
          (row.created ? '<div><span class="font-semibold text-slate-700">Created:</span> <span class="text-slate-600">' + row.created + '</span></div>' : '') +
          '</div>',
        icon: 'info',
        confirmButtonText: 'Close',
      });
    }

    async function editMkoa(row) {
      clearError();
      const { value: formValues } = await Swal.fire({
        title: 'Edit region',
        html:
          '<div class="space-y-3 text-left">' +
          '<label class="block text-sm font-medium text-slate-700 mb-1">Name</label>' +
          '<input id="swal-name" class="swal2-input" value="' + (row.name || '').replace(/"/g, '&quot;') + '">' +
          '<label class="block text-sm font-medium text-slate-700 mb-1">Code</label>' +
          '<input id="swal-code" class="swal2-input" value="' + (row.code || '').replace(/"/g, '&quot;') + '">' +
          '</div>',
        focusConfirm: false,
        showCancelButton: true,
        preConfirm: () => {
          const name = document.getElementById('swal-name').value.trim();
          const code = document.getElementById('swal-code').value.trim();
          if (!name || !code) {
            Swal.showValidationMessage('Name and code are required');
            return false;
          }
          return { name, code };
        },
      });
      if (!formValues) return;

      try {
        const res = await fetch(API_BASE + '/mkoa/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: row.id,
            name: formValues.name,
            code: formValues.code,
            updated_by: 1,
            status: row.status || 'active',
          }),
        });
        const json = await res.json();
        if (json.code === 202) {
          await Swal.fire({
            title: 'Updated',
            text: json.message || 'Region updated successfully.',
            icon: 'success',
            timer: 1800,
            showConfirmButton: false,
          });
          loadList();
        } else {
          const msg = json.error || 'Update failed';
          showError(msg);
          await Swal.fire({ title: 'Error', text: msg, icon: 'error' });
        }
      } catch (e) {
        const msg = 'Request failed: ' + e.message;
        showError(msg);
        await Swal.fire({ title: 'Error', text: msg, icon: 'error' });
      }
    }

    async function deleteMkoa(id, name) {
      clearError();
      var result = await Swal.fire({
        title: 'Delete region?',
        html: 'Delete <strong>' + (name || '') + '</strong> (ID ' + id + ')?<br><span class="text-gray-500 text-sm">This will soft-delete the record.</span>',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete'
      });
      if (!result.isConfirmed) return;
      try {
        const res = await fetch(API_BASE + '/mkoa/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, deleted_by: 1 })
        });
        const json = await res.json();
        if (json.code === 202) {
          await Swal.fire({ title: 'Deleted', text: 'Region was deleted.', icon: 'success', timer: 1500, showConfirmButton: false });
          loadList();
        } else {
          showError(json.error || 'Delete failed');
          Swal.fire({ title: 'Error', text: json.error || 'Delete failed', icon: 'error' });
        }
      } catch (e) {
        showError('Request failed: ' + e.message);
        Swal.fire({ title: 'Error', text: 'Request failed: ' + e.message, icon: 'error' });
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadList);

    document.getElementById('createForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const name = document.getElementById('newName').value.trim();
      const code = document.getElementById('newCode').value.trim();
      if (!name || !code) return;
      clearError();

      try {
        const res = await fetch(API_BASE + '/mkoa/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, code: code, created_by: 1 })
        });
        const json = await res.json();

        if (json.code === 201) {
          document.getElementById('newName').value = '';
          document.getElementById('newCode').value = '';
          loadList();
          await Swal.fire({ title: 'Created', text: (json.data && json.data.message) || 'Region created successfully.', icon: 'success', timer: 2000, showConfirmButton: false });
        } else {
          var msg = json.error || 'Create failed';
          showError(msg);
          await Swal.fire({ title: 'Error', text: msg, icon: 'error' });
        }
      } catch (e) {
        var msg = 'Request failed: ' + e.message;
        showError(msg);
        await Swal.fire({ title: 'Error', text: msg, icon: 'error' });
      }
    });

    loadList();
  </script>
</body>
</html>
